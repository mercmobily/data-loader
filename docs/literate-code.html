<!DOCTYPE html>


<html lang="en">
<head>
  <title>Location-based record loading</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link rel="stylesheet" media="all" href="template.css" />
  <link rel="stylesheet" media="all" href="normalize.css" />
  <link rel="stylesheet" media="all" href="extra.css" />

  <script type="module" src="/lib/material-esm.js"></script>
  <script type="module" src="/lib/tpe-esm.js"></script>

  


</head>
<body>
  <ee-header id="header" class="header" >
    <div slot="header-title" style="display: flex;">
      <div id="logo" alt="TPE"></div>
      <h3 class="page-title" >Location-based record loading</h3>
    </div>
    
      <nav class="header-menu" slot="actions" role="navigation">
        <ul>
          
            
            
              <li>
                  <a class="source " href="index.html">
                      home
                  </a>
              </li>
            
          
            
            
              <li>
                  <a class="source " href="documentation.html">
                      documentation
                  </a>
              </li>
            
          
            
            
              <li>
                  <a class="source  current " href="literate-code.html">
                      literate code
                  </a>
              </li>
            
          
        </ul>
      </nav>
    
    <div class="links" slot="actions">
      <a href="https://github.com/mobily-enterprises/tpe" target="_blank" title="View on GitHub">
        <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <title>GitHub icon</title>
          <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/>
        </svg>
      </a>
    </div>
  </ee-header>
  <main role="main">
    
    

      <nav class="toc" role="navigation">
        <ul>
          
            
            
              <li>
                <a class="source " href="index.html">
                    home
                </a>
              </li>
          
            
            
              <li>
                <a class="source " href="documentation.html">
                    documentation
                </a>
              </li>
          
            
            
              <li>
                <a class="source  current " href="literate-code.html">
                    literate code
                </a>
              </li>
          
        </ul>
      </nav>
    

    <section class="content-page">

      
      
        <article class="literate-code.js">
      
                  
          <p>All Single Page Applications need to handle their routing. This means that for example when viewing a contact,
the page is supposed to have, in the Location bar, all of the information it needs to load that contact’s record. 
For example, viewing /users/10 is enough to tell the client side to show the information about
the user with ID 10. Viewing /users should display all users as a list; /users/10/addresses should display all addresses
belonging to user with ID 10; /users/10/addresses/20 should display the address with ID 20, owned by the user with ID 10.
This code assumes that each type of datum (users, addresses, etc.) will have an endpoint, and that each endpoint provides
a way to get a specific ID (e.g. /users/10) and to get a list of records (e.g. /users or /addresses). They are called “stores” in
the code, since they are endpoints that store data. The code also expects the endpoint to following the same name convention
as the URL – so, for example viewing /users/10 in the Single Page Application will run a GET request on the URL
/users/10; or, if viewing the page /users/10/addresses/20, it will make two requests, /users/10 and /addresses/20 (unless
pre-loading was used – more on this later).</p>
<p>The end goal of the code is to run <code>fetch()</code> calls, and fill in the object <code>loadedElementData</code> with the loaded data in
as properties with the suffix <code>Record</code>. For example:</p>
<ul>
<li><p>loading the page /users/10 in an SPA, assuming a page path of /users/:userId should result in the <code>loadedData</code> object 
containing <code>{ userIdRecord: { id: 10, name: ..., ... } }</code>;</p>
</li>
<li><p>loading the page <code>/users/10/address/20</code> assuming a page path of /users/:userId/addresses/:addressId should result
in the <code>loadedData</code> object containing <code>{ userIdRecord: { id: 10, name: &#39;..., ... }, addressIdRecord: { id: 20, ... } }</code></p>
</li>
</ul>
<h2 id="minimising-requests">Minimising requests</h2>

          
                  
          <p>There is a case to be made, however, where loading /addresses/20 will return a record which <em>already includes</em> all the data you
would possibly need for the <em>user</em> with ID 10, as long as the address record follows an established naming convention.</p>
<p>For example, loading /addresses/20 might return a record that includes the key <code>userIdRecord</code> (<code>{ userIdRecord: {id: 2, ...}}</code>) 
If that is the case, <em>then</em> call /users/1 would be a very expensive waste of resources (bandwidth, server power, DB requests,
and so on). If loading /addresses/20 returns a record which will include the property <code>userIdRecord</code>, then the second
request would be wasteful, and won’t be carried out. Note that queries should be carried out in reverse order, so that
if the page <code>/users/10/address/20</code> is visited, the address record will be loaded first, and then the user record. This
is because the last record is likely to be more specific than the previous ones – and possibly already contain the
parents’ records.</p>
<h2 id="making-requests">Making requests</h2>

          
                  
          <p>It is also assumed that a page might need more data from more stores than the ones used in in the page’s URL.
For example, the application’s URL might be /carModels/:carModelId; however, the page might want to <em>also</em> display
information about the car <em>maker</em> for that model. 
In this case, the element will have a dataUrl like this /carMakers/:carMakerId/carModels/:carModelId whereas the page’s URL 
(just /carModels/:carModelId) will only provide enough information for one store call to carModels. Note that 
in most cases page URL and data URL will be the same; however, there are case like this one where a page’s URL is 
shorter than the data URL. For example, an element could be used in two different paths, one specific one matching
the data URL, and one less specific one shorter than the page URL.</p>
<p>This case is also covered: the code will load /carModels, and then look for any sign of a property called carMakerId 
in the returned record. If present (e.g. <code> { ... carMakerId: 50 }</code>), it will “fill in the void”: it will load
/carMakers/50 hence providing data to the element (unless the record also returns <code>carMakersRecord</code>, in which case
loading would be unnecessary, as explained in the previous section).</p>
<p>Remember that if the data URL is <code>/carMakers/:carMakerId/carModels/:carModelId</code>, the code will expect to need two
calls: one on the <code>carModels</code> store, and one to the <code>carMakers</code> store, in that order (last to first).</p>
<p>For example if a user visits /carModels/2, the code will scan the data URL (<code>/carMakers/:carMakerId/carModels/:carModelId</code>)
and will start from <code>carModels/:carModelId</code> (the last store/id pair): it will load it by querying the server for 
<code>/carModels/2</code>). If the returned record has <code>{ id: 2, name: &quot;Model 3&quot;, carMakerId: 10 }</code>, since the data URL has an
ID (<code>:carModelId</code>) that matches the record’s property (<code>carModelId</code>), the code will know that to complete loading
(that is, to load <code>/carMakers/:carMakerId</code>) it should use the ID <code>10</code> (<code>/carMakers/10</code>) to complete loading.</p>
<p>As explained above, if the record returned by /carModels <em>also</em> contains makerIdRecord, the second call will NOT be
made at all: makerIdRecord will be assigned directly to loadedElementData without making a further request. This allows
further optimisation of network traffic.</p>
<h2 id="aggressive-or-non-aggressive-requests">Aggressive or non-aggressive requests</h2>

          
                  
          <p>An element URL like this: /carMakers/:carMakerId/carModels/:carModelId facing a request like
carMakers/10/carModels/20  will trigger a fetch call on carModels/20; the received record is then checked: does it contain
a field called <code>carMakersRecord</code>? If so, a call to /carMakers/ will NOT be carried out, since it will be superfluous (the
data has already been received from the server and it’s assumed to be correct).</p>
<p>However, there are some cases where it’s <em>known</em> that /carModels  will <em>not</em> return carMakerIdRecord. In 
this case, it’s ideal to enable <em>aggressive loading</em>, where the two requests (/carMakers/10 and carModels/20) are
run concurrently. Without aggressive loading, even thought a car model does NOT return any information about the car
maker, the request to the carMaker would only happen once the first request to carModel has completed.</p>
<h2 id="lists">Lists</h2>

          
                  
          <p>When visiting a page such as <code>/users/10/addresses</code> (with URL template /users/:userId/addresses), the expected result is a
list of addresses. Assuming that the element has a dataUrl that matches the page URL, this code will first resolve the
single-records (in this case, it will request <code>/user/10</code> to the server); it will then query the server for the
addresses with adequate filtering; so, the endpoint will be <code>/addresses?userId=10</code>).</p>
<h1 id="the-code">The code</h1>

          
                  
          <p>The function that does the magic is this one:</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 89;"><span class="line" id="L89"><span style="color: #D32F2F">export</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">async</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">function</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">loader</span><span style="color: #24292EFF"> (dataUrl </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&#39;&#39;</span><span style="color: #212121">,</span><span style="color: #24292EFF"> routingData </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> {}</span><span style="color: #212121">,</span><span style="color: #24292EFF"> isList </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">false</span><span style="color: #212121">,</span><span style="color: #24292EFF"> elementData</span><span style="color: #212121">,</span><span style="color: #24292EFF"> config) {</span></span>
<span class="line" id="L90"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">dataUrlInfo</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">makeUpDataUrlInfo</span><span style="color: #24292EFF"> (dataUrl</span><span style="color: #212121">,</span><span style="color: #24292EFF"> routingData</span><span style="color: #212121">,</span><span style="color: #24292EFF"> isList)</span></span>
<span class="line empty-line" id="L91"></span>
<span class="line" id="L92"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">loadData</span><span style="color: #24292EFF"> (dataUrlInfo</span><span style="color: #212121">,</span><span style="color: #24292EFF"> dataUrl</span><span style="color: #212121">,</span><span style="color: #24292EFF"> routingData</span><span style="color: #212121">,</span><span style="color: #24292EFF"> isList</span><span style="color: #212121">,</span><span style="color: #24292EFF"> elementData</span><span style="color: #212121">,</span><span style="color: #24292EFF"> config)</span></span>
<span class="line" id="L93"><span style="color: #24292EFF">}</span></span>
<span class="line empty-line" id="L94"></span>
<span class="line empty-line" id="L95"></span>
<span class="line empty-line" id="L96"></span></code></pre>
          
                  
          <p>The parameters for the <code>loader()</code> function are:</p>
<ul>
<li><code>dataUrl</code> - the data URL that will spell out, in URL format, the store and ID fields to load. For example,
 it could be <code>/users/:userId/address/:addressId</code>. It is likely match the element’s routing URL, although it may not</li>
<li><code>routingData</code> - the data taken from the page’s URL. This will come from the router, which will get the
 window’s location and extrapolate a key/value hash. The page URL might be the same as the data URL
 (for example the page URL might also be <code>/users/:userId/address/:addressId</code>, resulting in <code>{ users: 10, address: 20}</code>)
 or it might be shorter (<code>/address/:addressId</code>, resulting in <code>{ address: 20}</code>). In those cases where the
 <code>routingData</code> is missing IDs, this code will try and look for <code>userId</code> in the loaded records (for example
 it will look for the property <code>userId</code> in the loaded address) </li>
<li><code>isList</code> - a flag that, if true, indicates that the last part of the data URL is the name of a store which
will be queried without an ID, and therefore expecting to receive an array. For example the data URL
<code>/users/:userId/address/</code> can be used to fetch all the addresses associated to the user, with
the query <code>GET /addresses?userId=XX</code>. The code will throw an error if this flag is true and the last part if
the data URL a <code>:something</code> rather than a clear store name. </li>
<li><code>elementData</code> - the object which <em>might</em> contain properties with preloaded data. For example for a data URL
like <code>/users/:userId/address/:addressId</code>, if the elementData object already contains the
properties <code>userIdRecord</code> and <code>addressIdRecord</code>, then nothing will be loaded. This is useful in the context
of <code>elementData</code> being the HTML custom element displaying the information, and having properties set.</li>
<li><code>config</code> - an object with further configuration parameters:<ul>
<li><code>storeUrlPrefix</code>. The prefix used to make GET calls to the store.</li>
<li><code>fetchUrlMofifier</code>. A function that can be used to change the store’s URL in whichever way necessary
to comply to the server. It receives as parameters <code>url</code>, <code>store</code>, <code>nakedStoreUrl</code>, <code>idParamValue</code>,
<code>searchParams</code> and <code>dataUrlInfo</code></li>
<li><code>aggressiveLoading</code>. A flag that will enable aggressive loading (more requests, and less chance to minimise
the number of requests)</li>
<li><code>fetch</code>. The function used to fetch. Must have the exact same signature as <code>window.fetch()</code></li>
<li><code>verbose</code>. If true, it will print information to the console.</li>
</ul>
</li>
</ul>
<p>The <code>loader</code> function works in two steps.</p>
<h2 id="first-step-create-dataurlinfo">First step: create <code>dataUrlInfo</code></h2>

          
                  
          <p>The first step passes the first three parameters passed to <code>loader()</code> (<code>dataUrl</code>, <code>routingData</code> and <code>isList</code>) to the
function <code>makeUpDataUrlInfo()</code>, which returns a <code>dataUrlInfo</code> object.</p>
<p>The <code>dataUrlInfo</code> variable is the result of the result of the analisys the data URL and the routing data, so that
information about the data URL is available as data rather than a string. </p>
<p>The end result has the following properties:</p>
<ul>
<li><code>store2IdParams</code> - a hash used throughout the code to lookup which idParam
is used for a particular store. For example for the URL /users/:userId/addresses/:addressId,
store2IdParams.addresses === ‘addressId’ (meaning that the store ‘addresses’ will lookup data
using the address `addressId)</li>
<li>idParamsValues - an object with the values of each idParams, taken from <code>routingData</code>. If the element’s URL is
the same  as the data URL, then it will be identical to routingData. However, if the data URL has more information,
(for example the page’s URL is <code>addresses/:addressId</code> and the page’s URL is <code>/users/:userId/addresses/:addressId</code>,
<code>isParamsValues</code> will have two properties: <code>addressId</code> (containing the ID of the address, taken from the page’s URL) and
<code>userId</code> (set to null). More commonly, they will differ if the URL uses a different naming convention for stores.
For example the data URL could be <code>/users/:userId/addresses/:addressId</code> whereas the page URL might be
<code>/u/:userId/addr/:addressId</code>.   </li>
<li><code>listStore</code>. If isList is true, it will contain the name of the list store (for example ‘addresses’
when the data URL is <code>/users/:userId/addresses</code> </li>
<li>listFilter - an object with keys/values which by default will correspond ot the values in idParamsValue.
If you have a store with dataPath <code>/users/:userId/addresses</code>, the system will load the user <code>userId</code> from the store
<code>users</code> (that is, <code>/users/1</code>) and will also query the <code>addresses</code> store without passing an ID (<code>GET /addresses</code>)
whicn will return an array of addresses. However, since the user <code>1</code> is being viewed, it can be
assumed that only the addresses for that user will be relevant. So, the query will actually me <code>GET /addresses?userId=1</code>.
There is a specific variable for <code>listFilter</code> because the callack <code>fetchUrlModifier()</code> might change the listFilter
without changing <code>idParamsValues</code></li>
</ul>
<p>Note that in a URL stores cannot be repeated, whereas paramIds can. So theoretically a data URL could be
something like <code>/users/:userId/usersExtra/:userId/addresses/:addressId</code>. To cycle through the data URL, the
code will commonly do this:</p>
<pre><code><pre class="shiki" style="background-color: transparent"><code ><span class="line"><span style="color: #D32F2F">for</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> store </span><span style="color: #D32F2F">in</span><span style="color: #24292EFF"> resolvedIdParamsValues) { </span></span>
<span class="line"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">idParam</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> store2IdParams[store]</span></span></code></pre>
</code></pre>
<p>This effectively will go through the stores/idParams pairs.</p>
<h2 id="second-step-actually-loading-data-if-necessary-via-loaddata">Second step: actually loading data (if necessary) via <code>loadData()</code></h2>

          
                  
          <p>The second step passes the newly obtained <code>dataUrlInfo</code> object, as well as all of the parameters of the <code>loader()</code> function,
to the <code>loadData()</code> function, which will do the actual loading (sending <code>fetch()</code> requests to the server and storing
the results).</p>
<p>The ultimate goal of the <code>loader()</code> function is to return an object with the following properties:</p>
<ul>
<li>loadedElementData. The actual loaded data.</li>
<li>resolvedIdParamsValues - the ‘resolved’ version of idParamsValues. The variable paramsValues might be incomplete if
for example the page URL is /addresses/:addressid whereas the store data URL is /users/:userId/addresses/:addressid.
In this case the code will load /addresses/10 and then look in the record for an <code>userId</code> property. So, idParamsValues
will be { userId: 10 } whereas resolvedIdParamsValues will be (for example) <code>{ userId: 10, addressId: 20 }</code>.</li>
<li>resolvedListFilter - the ‘resolved’ version of listFilter. The same logic as <code>resolvedIdParamsValues</code> applies.</li>
</ul>
<p>Here is the code to make all of this happen.</p>
<h1 id="the-function-makeupdataurlinfo">The function <code>makeUpDataUrlInfo()</code></h1>

          
                  
          <p>This function is very straightforward. It will go through the process of splitting the dataUrl variable into
tokens separated by ‘/‘ (the URL separator), and return the dataUrlInfo object which includes idParamsValues, 
<code>store2IdParams</code> and (for lists) <code>listStore</code> and <code>listFilter</code>. </p>
<p>Here is the function, which is rather straightforward:</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 190;"><span class="line" id="L190"><span style="color: #24292EFF"> </span><span style="color: #D32F2F">function</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">makeUpDataUrlInfo</span><span style="color: #24292EFF"> (dataUrl</span><span style="color: #212121">,</span><span style="color: #24292EFF"> routingData </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> {}</span><span style="color: #212121">,</span><span style="color: #24292EFF"> isList) {</span></span>
<span class="line" id="L191"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">tokens</span><span style="color: #24292EFF">  </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">dataUrl</span><span style="color: #6F42C1">.split</span><span style="color: #24292EFF">(</span><span style="color: #22863A">&#39;/&#39;</span><span style="color: #24292EFF">)</span><span style="color: #6F42C1">.filter</span><span style="color: #24292EFF">(s </span><span style="color: #D32F2F">=&gt;</span><span style="color: #24292EFF"> s)</span></span>
<span class="line empty-line" id="L192"></span>
<span class="line" id="L193"><span style="color: #24292EFF">  </span><span style="color: #C2C3C5">/* For lists, the last part must not be a `:` */</span></span>
<span class="line" id="L194"><span style="color: #24292EFF">  </span><span style="color: #C2C3C5">/* since a list request must end with a store */</span></span>
<span class="line" id="L195"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (tokens[</span><span style="color: #1976D2">tokens</span><span style="color: #24292EFF">.</span><span style="color: #1976D2">length</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">-</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">1</span><span style="color: #24292EFF">][</span><span style="color: #1976D2">0</span><span style="color: #24292EFF">] </span><span style="color: #D32F2F">===</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&#39;:&#39;</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">&amp;&amp;</span><span style="color: #24292EFF"> isList) {</span></span>
<span class="line" id="L196"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">throw</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Error</span><span style="color: #24292EFF">(</span><span style="color: #22863A">&#39;In list stores, the last part of the URL must not start with &quot;:&quot;&#39;</span><span style="color: #24292EFF">)</span></span>
<span class="line" id="L197"><span style="color: #24292EFF">  }</span></span>
<span class="line" id="L198"><span style="color: #24292EFF">  </span></span>
<span class="line" id="L199"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> previousPartIsAStore </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">false</span></span>
<span class="line" id="L200"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> store </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">null</span></span>
<span class="line" id="L201"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> idParamsValues </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> {}</span></span>
<span class="line" id="L202"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> listFilter </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> {}</span></span>
<span class="line" id="L203"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> store2IdParams </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> {}</span></span>
<span class="line" id="L204"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">for</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> i </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">0</span><span style="color: #212121">,</span><span style="color: #24292EFF"> l </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">tokens</span><span style="color: #24292EFF">.</span><span style="color: #1976D2">length</span><span style="color: #24292EFF">; i </span><span style="color: #D32F2F">&lt;</span><span style="color: #24292EFF"> l; i</span><span style="color: #D32F2F">++</span><span style="color: #24292EFF">) {</span></span>
<span class="line empty-line" id="L205"></span>
<span class="line" id="L206"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> t </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> tokens[i]</span></span>
<span class="line" id="L207"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (t[</span><span style="color: #1976D2">0</span><span style="color: #24292EFF">] </span><span style="color: #D32F2F">!==</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&#39;:&#39;</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L208"><span style="color: #24292EFF">      store </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> t</span></span>
<span class="line" id="L209"><span style="color: #24292EFF">      previousPartIsAStore </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">true</span></span>
<span class="line" id="L210"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">continue</span></span>
<span class="line" id="L211"><span style="color: #24292EFF">    }</span></span>
<span class="line" id="L212"><span style="color: #24292EFF">    </span></span>
<span class="line" id="L213"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (t[</span><span style="color: #1976D2">0</span><span style="color: #24292EFF">] </span><span style="color: #D32F2F">===</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&#39;:&#39;</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L214"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> idParam </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">t</span><span style="color: #6F42C1">.substring</span><span style="color: #24292EFF">(</span><span style="color: #1976D2">1</span><span style="color: #24292EFF">)</span></span>
<span class="line empty-line" id="L215"></span>
<span class="line" id="L216"><span style="color: #24292EFF">      </span><span style="color: #C2C3C5">/* Sanity check in the URL. You can&#39;t write something like /something/:someId/:someOtherId */</span></span>
<span class="line" id="L217"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">!</span><span style="color: #24292EFF">previousPartIsAStore) </span><span style="color: #D32F2F">throw</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Error</span><span style="color: #24292EFF">(</span><span style="color: #22863A">`Part </span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">idParam[</span><span style="color: #1976D2">0</span><span style="color: #24292EFF">]</span><span style="color: #D32F2F">}</span><span style="color: #22863A"> doesn&#39;t have a corresponding store in url </span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">dataUrl</span><span style="color: #D32F2F">}</span><span style="color: #22863A">`</span><span style="color: #24292EFF">)</span></span>
<span class="line empty-line" id="L218"></span>
<span class="line" id="L219"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> idParamValue </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> routingData[idParam] </span><span style="color: #D32F2F">||</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">null</span></span>
<span class="line" id="L220"><span style="color: #24292EFF">      </span></span>
<span class="line" id="L221"><span style="color: #24292EFF">      </span><span style="color: #C2C3C5">/* Assign the main variables */</span></span>
<span class="line" id="L222"><span style="color: #24292EFF">      idParamsValues[store] </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> idParamValue</span></span>
<span class="line" id="L223"><span style="color: #24292EFF">      store2IdParams[store] </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> idParam</span></span>
<span class="line empty-line" id="L224"></span>
<span class="line" id="L225"><span style="color: #24292EFF">      </span><span style="color: #C2C3C5">/* If it&#39;s a list, add the item to the query string */</span></span>
<span class="line" id="L226"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (isList) {</span></span>
<span class="line" id="L227"><span style="color: #24292EFF">        listFilter[idParam] </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> idParamValue</span></span>
<span class="line" id="L228"><span style="color: #24292EFF">      }</span></span>
<span class="line" id="L229"><span style="color: #24292EFF">    }</span></span>
<span class="line empty-line" id="L230"></span>
<span class="line" id="L231"><span style="color: #24292EFF">  }</span></span>
<span class="line empty-line" id="L232"></span>
<span class="line" id="L233"><span style="color: #24292EFF">  </span><span style="color: #C2C3C5">/* At this stage, `store` will be the last store encountered. So, for lists it will be */</span></span>
<span class="line" id="L234"><span style="color: #24292EFF">  </span><span style="color: #C2C3C5">/* the actual list store (since the URL always must end with the list store*/</span></span>
<span class="line empty-line" id="L235"></span>
<span class="line" id="L236"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">result</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L237"><span style="color: #24292EFF">    idParamsValues</span><span style="color: #212121">,</span></span>
<span class="line" id="L238"><span style="color: #24292EFF">    store2IdParams</span><span style="color: #212121">,</span></span>
<span class="line" id="L239"><span style="color: #24292EFF">    listStore</span><span style="color: #D32F2F">:</span><span style="color: #24292EFF"> isList </span><span style="color: #D32F2F">?</span><span style="color: #24292EFF"> store </span><span style="color: #D32F2F">:</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">null</span><span style="color: #212121">,</span></span>
<span class="line" id="L240"><span style="color: #24292EFF">    listFilter</span><span style="color: #D32F2F">:</span><span style="color: #24292EFF"> isList </span><span style="color: #D32F2F">?</span><span style="color: #24292EFF"> listFilter </span><span style="color: #D32F2F">:</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">null</span><span style="color: #212121">,</span><span style="color: #24292EFF">      </span></span>
<span class="line" id="L241"><span style="color: #24292EFF">  }</span></span>
<span class="line" id="L242"><span style="color: #24292EFF">  </span></span>
<span class="line" id="L243"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> result</span></span>
<span class="line" id="L244"><span style="color: #24292EFF">}</span></span>
<span class="line empty-line" id="L245"></span>
<span class="line empty-line" id="L246"></span></code></pre>
          
                  
          <p>At this stage ome information might still be partial. For example, potentially some parmaIds might be
essentially missing (if the page URL is smaller than the data URL, for example).</p>
<h1 id="the-function-loaddata">The function <code>loadData()</code></h1>

          
                  
          <p>This function will load the data in the most intelligent way possible.
In a perfect world, the data URL and the page path are the same (e.g. <code>/users/:userId/address/:addressId</code>). However,
things don’t always work out this way. For example page path could be <code>/addresses/:addressId</code>, <em>without</em> including
the userId.</p>
<p>When reading this code, remember that _the ultimate goal of this function is to add properties to the <code>loadedElementData</code>
object. The name of the properties will match the idParams names, followed by the word
<code>Record</code>. For example the data URL <code>/users/:userId/address/:addressId</code> will need to ensure that the properties
<code>userIdRecord</code> and <code>addressIdRecord</code> are added to  the <code>loadedElementData</code> object – unless they are already
present in the <code>elementData</code> record.</p>
<p>In the case above, if <code>userIdRecord</code> and <code>addressIdRecord</code> are <em>already</em> defined in <code>elementData</code>, then <em>nothing</em>
should be loaded.</p>
<p>At the same time, if the page path actually is <code>/addresses/:addressId</code> and the data URL is
<code>/users/:userId/address/:addressId</code>, then it will be necessary work out the userId “somehow”.</p>
<p>For example if the page /addresses/10 is visited, the data URL <code>/users/:userId/address/:addressId</code> will imply
the fetching of the address with ID 10, and then the fetching of the user with a not-yet-specified ID. So, where does
the user ID actually come from? What will happen is that the address with ID 10 will be fetched, and if the record has a
property called <code>userId</code>, that will be taken as the correct value for the <code>fetch</code> call in the <code>users</code> store.
As explained already several times, if the property <code>userIdRecord</code> is already present in the newly loaded address record,
then loading will be skipped for the user record.
If no userId property can be found in the address object, the load will fail.</p>
<p>Note that dataUrl and routingData are technically unnecessary to this function; they are passed here
for consistency and readability of the code.</p>
<p>Here is the function.</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 280;"><span class="line" id="L280"><span style="color: #D32F2F">async</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">function</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">loadData</span><span style="color: #24292EFF"> (dataUrlInfo</span><span style="color: #212121">,</span><span style="color: #24292EFF"> dataUrl</span><span style="color: #212121">,</span><span style="color: #24292EFF"> routingData</span><span style="color: #212121">,</span><span style="color: #24292EFF"> isList</span><span style="color: #212121">,</span><span style="color: #24292EFF"> elementData</span><span style="color: #212121">,</span><span style="color: #24292EFF"> config) {</span></span>
<span class="line empty-line" id="L281"></span>
<span class="line empty-line" id="L282"></span></code></pre>
          
                  
          <p>First of all, the configuration values are turned into shorter variable</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 283;"><span class="line" id="L283"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">storeUrlPrefix</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">config</span><span style="color: #24292EFF">.storeUrlPrefix</span></span>
<span class="line" id="L284"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">fetchUrlModifier</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">config</span><span style="color: #24292EFF">.fetchUrlModifier</span></span>
<span class="line" id="L285"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">aggressiveLoading</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">!!</span><span style="color: #1976D2">config</span><span style="color: #24292EFF">.aggressiveLoading</span></span>
<span class="line" id="L286"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">fetch</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">config</span><span style="color: #24292EFF">.fetch </span><span style="color: #D32F2F">||</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">window</span><span style="color: #24292EFF">.fetch</span></span>
<span class="line empty-line" id="L287"></span>
<span class="line empty-line" id="L288"></span></code></pre>
          
                  
          <p>The hash store2IdParams is also turned into something shorter, since it will be used a lot in the following ode </p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 289;"><span class="line" id="L289"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">store2IdParams</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">dataUrlInfo</span><span style="color: #24292EFF">.store2IdParams</span></span>
<span class="line empty-line" id="L290"></span>
<span class="line empty-line" id="L291"></span></code></pre>
          
                  
          <p>The following three variables are really important in this code, because they will be the actual final output
of this function. The main one is obviously <code>loadedElementData</code>, the object with the actual data. The function
also returns <code>resolvedIParamsValues</code> and <code>resolvedListFilter</code>, which are “completed” versions of their
counterparts <code>idParamValues</code> and <code>listFilter</code>, which can be incomplete in case the page URL doesn’t include all of the
IDs for the data URL. the “resolved” versions will include all of the IDs, including the newly found one.</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 296;"><span class="line" id="L296"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">loadedElementData</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> {}</span></span>
<span class="line" id="L297"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">resolvedIdParamsValues</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> { </span><span style="color: #D32F2F">...</span><span style="color: #1976D2">dataUrlInfo</span><span style="color: #24292EFF">.idParamsValues }</span></span>
<span class="line" id="L298"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">resolvedListFilter</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> { </span><span style="color: #D32F2F">...</span><span style="color: #1976D2">dataUrlInfo</span><span style="color: #24292EFF">.listFilter }  </span></span>
<span class="line empty-line" id="L299"></span>
<span class="line empty-line" id="L300"></span></code></pre>
          
                  
          <p>To load all of the records, this function essentually works as an endless while loop, which
breaks once either all of the data is actually loaded, or if there isn’t enough
information to actually complete loading all required data.</p>
<p>Within the <code>while</code> loop, there is a <code>for</code> loop where the data URL’s parameters are taken in reverse order.
Note that this loop will be potentially iterated several times.</p>
<p>Each iteration of the loop can be seen as an attempt to add something to add to the loading queue (<code>toLoad</code>); anything in
the loading queue will be loaded immediately after the end of the <code>for</code> cycle. As long as <em>something</em> is loaded, a new
<code>for</code> cycle is restarted again thanks to the endless <code>while</code> loop.</p>
<p>Very importantly, when something is loaded the record is analysed, effectively looking for paramIds that were
potentially still missing in the <code>resolvedIdParamsValues</code> hash. </p>
<p>The <code>while</code> loop will break free in two cases.</p>
<p>  (1) the <code>for</code> cycle didn’t add anything in the loading queue <em>and</em> there were unresolved idParams; this is the
  unwanted case:  an error will be thrown since the function was unsuccessful for lack of IDs</p>
<p>  (2) the <code>for</code> cycle didn’t add anything in the loading queue <em>and</em> there were <em>no</em> unresolved idParams; this is the
  successful case: everything was loaded, and a <code>break</code> statement will break out of the endless <code>while</code> loop.</p>
<p>For clarity, here are some example cases.</p>
<h2 id="case-1">Case 1</h2>

          
                  
          <p><em>In this case, data URL is <code>/users/:userId/addresses/:addressId</code> and the page URL is <code>/addresses/:addressId</code> and the
address record includes <code>userId</code>. Location is assumed to be <code>/users/10/addresses/20</code></em></p>
<p>When the <code>while</code> loop starts, <code>resolvedIdParamsValues</code> is <code>{ addressId: 20, userId: null }</code> and <code>loadedElementData</code> is <code>{}</code>.
The for cycle starts: the first key is <code>addressId</code> (the last one). Since the value is not null (in fact, it’s 20).
The first value considered is <code>addressId</code>, which has a value of 20. Since <code>loadedElementData</code> doesn’t include a
property <code>addressIdRecord</code> (yet), <code>toLoad</code> array will have one entry added (to load the address). And since
aggressive loading is off, only one entry will be added in the <code>for</code> cycle – which breaks away.</p>
<p>Once out, there is one entry to load: the promise is resolved, the loading of the address record actually happens.
Once loaded, the full record is added to <code>loadedElementData</code> (with key <code>addressIdRecord</code>).
The record is then analysed: does it contain a known <code>idParam</code>? As it turns out, it does: the record
has <code>{ userId: 10, addressLine1: ..., ...}</code>. So, the known <code>idParam</code> is added to <code>resolveIdParamsValue</code> (with key
<code>addressId</code>).</p>
<p>The endless <code>while</code> cycle will start again. However, this time <code>resolvedIdParamsValues</code> is 
<code>{ addresses: 20, users: 10 }</code> and <code>loadedElementData</code> is <code>{ addressIdRecord: { userId: 10, ... } }</code>.
The first value considered is <code>addressId</code>, value <code>20</code>. Since there is <em>already</em> a key <code>addressIdRecord</code> in
<code>loadedElementData</code>, the value is essentially skipped with a <code>continue</code> statement.
The next value considered is <code>userId</code>, value <code>10</code> (which came from the addressId object, when it was loaded).
Since <code>loadedElementData</code> doesn’t include a
property <code>userIdRecord</code> (yet), <code>toLoad</code> array will have one entry added (to load the user). And since
aggressive loading is off, only one entry will be added in the <code>for</code> cycle – which breaks away.</p>
<p>Once out, there is one entry to load: the promise is resolved, the loading of the user record actually happens, at
which point the returned record is analysed: does it contain a known <code>idParam</code>? It doesn’t, so nothing happens.</p>
<p>The endless <code>while</code> cycle will start again. <code>resolvedIdParamsValues</code> is still <code>{ addresses: 20, useres: 10 }</code>,
but <code>loadedElementData</code> includes the <code>userIdRecord</code> property <code>{ addressIdRecord: { userId: 10, ... }, userIdRecord: { ... } }</code>.</p>
<p>This means that both <code>idParams</code> will effectively skip. At the end of the cycle, the <code>toLoad</code> array will be empty, <em>and</em>
the flag <code>nullAndUnloadedPresent</code> will be false: this is the cue to break the not-so-endless <code>while</code> cycle.</p>
<p>Loading was successful.</p>
<h2 id="case-2">Case 2</h2>

          
                  
          <p><em>In this case, data URL is <code>/users/:userId/addresses/:addressId</code> and the page URL is <code>/addresses/:addressId</code> but the
address record does <em>not</em> include <code>userId</code>. Location is assumed to be <code>/users/10/addresses/20</code></em></p>
<p>When the <code>while</code> loop starts, <code>resolvedIdParamsValues</code> is <code>{ addressId: 20, userId: null }</code> and <code>loadedElementData</code> is <code>{}</code>.
The for cycle starts: the first key is <code>addressId</code> (the last one). Since the value is not null (in fact, it’s 20).
The first value considered is <code>addressId</code>, which has a value of 20. Since <code>loadedElementData</code> doesn’t include a
property <code>addressIdRecord</code> (yet), <code>toLoad</code> array will have one entry added (to load the address). And since
aggressive loading is off, only one entry will be added in the <code>for</code> cycle – which breaks away.</p>
<p>Once out, there is one entry to load: the promise is resolved, the loading of the address record actually happens.
Once loaded, the full record is added to <code>loadedElementData</code> (with key <code>addressIdRecord</code>).
The record is then analysed: does it contain a known <code>idParam</code>? The answer is no; the <code>resolveIdParamsValue</code>
is left unchanged.</p>
<p>The endless <code>while</code> cycle will start again. The <code>resolvedIdParamsValues</code> variable is still 
<code>{ addresses: 20, users: null }</code> and <code>loadedElementData</code> is <code>{ addressIdRecord: { userId: 10, ... } }</code>.
The first value considered is <code>addressId</code>, value <code>20</code>. Since there is <em>already</em> a key <code>addressIdRecord</code> in
<code>loadedElementData</code>, the value is essentially skipped with a <code>continue</code> statement.
The next value considered is <code>userId</code>, value <code>null</code> – which sets the <code>nullAndUnloadedPresent</code> variable to <code>true</code>.</p>
<p>At the end of the cycle, the <code>toLoad</code> array will be empty, <em>and</em>
the flag <code>nullAndUnloadedPresent</code> will be <code>true</code>: this is the cue that there isn’t enough data to complete the loading. </p>
<p>Loading was not successful.</p>
<h2 id="the-actual-code">The actual code</h2>

          
                  
          <p>The code starts with the endless <code>while</code> cycle described above. <code>alreadylookedInto</code> is a hash that will prevent
analysing a record twice. <code>nullAndUnloadedPresent</code> and <code>toLoad</code> are variables that will change in the <code>for</code> cycle.</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 390;"><span class="line" id="L390"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">alreadylookedInto</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> {}</span></span>
<span class="line" id="L391"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> totalLoads </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">0</span></span>
<span class="line" id="L392"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">while</span><span style="color: #24292EFF"> (</span><span style="color: #1976D2">true</span><span style="color: #24292EFF">) { </span></span>
<span class="line" id="L393"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> nullAndUnloadedPresent </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">false</span></span>
<span class="line" id="L394"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">toLoad</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> []</span></span>
<span class="line empty-line" id="L395"></span>
<span class="line empty-line" id="L396"></span></code></pre>
          
                  
          <p>The for cycle will go through the keys of <code>resolvedIdParamsValues</code>, to attempt the load. </p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 398;"><span class="line" id="L398"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">for</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">store</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">of</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Object</span><span style="color: #6F42C1">.keys</span><span style="color: #24292EFF">(resolvedIdParamsValues)</span><span style="color: #6F42C1">.reverse</span><span style="color: #24292EFF">()) {</span></span>
<span class="line" id="L399"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">idParam</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF">  store2IdParams[store]</span></span>
<span class="line empty-line" id="L400"></span>
<span class="line empty-line" id="L401"></span></code></pre>
          
                  
          <p>If there is already a …Record property in the [loaded]ElementData object, it means that data is already available,
So, this idParam will be skipped, and the function will progress towards the desirerable outcome of nothing to load
with no idParam set to null.</p>
<p>The function <code>lookIntoRecord()</code> will make sure that any idParams in the record is added to the <code>resolvedIdParams</code> hash.
The <code>lookIntoRecord</code> will make sure that any missing idParams in resolvedIdParamsValues are filled in by the record; the
<code>alreadylookedInto</code> hash makes sure that it only happens once per store.</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 409;"><span class="line" id="L409"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">record</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> elementData[</span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">idParam</span><span style="color: #D32F2F">}</span><span style="color: #22863A">Record`</span><span style="color: #24292EFF">] </span><span style="color: #D32F2F">||</span><span style="color: #24292EFF"> loadedElementData[</span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">idParam</span><span style="color: #D32F2F">}</span><span style="color: #22863A">Record`</span><span style="color: #24292EFF">]</span></span>
<span class="line" id="L410"><span style="color: #24292EFF">      </span></span>
<span class="line" id="L411"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (record) { </span></span>
<span class="line" id="L412"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">!</span><span style="color: #24292EFF">alreadylookedInto[</span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">idParam</span><span style="color: #D32F2F">}</span><span style="color: #22863A">Record`</span><span style="color: #24292EFF">]) {</span></span>
<span class="line" id="L413"><span style="color: #24292EFF">          </span><span style="color: #6F42C1">lookIntoRecord</span><span style="color: #24292EFF">(record</span><span style="color: #212121">,</span><span style="color: #24292EFF"> elementData</span><span style="color: #212121">,</span><span style="color: #24292EFF"> loadedElementData</span><span style="color: #212121">,</span><span style="color: #24292EFF"> resolvedIdParamsValues</span><span style="color: #212121">,</span><span style="color: #24292EFF"> resolvedListFilter</span><span style="color: #212121">,</span><span style="color: #24292EFF"> store2IdParams</span><span style="color: #212121">,</span><span style="color: #24292EFF"> isList</span><span style="color: #212121">,</span><span style="color: #24292EFF"> store)</span></span>
<span class="line" id="L414"><span style="color: #24292EFF">          alreadylookedInto[</span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">idParam</span><span style="color: #D32F2F">}</span><span style="color: #22863A">Record`</span><span style="color: #24292EFF">] </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">true</span></span>
<span class="line" id="L415"><span style="color: #24292EFF">        }</span></span>
<span class="line" id="L416"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">continue</span></span>
<span class="line" id="L417"><span style="color: #24292EFF">      }</span></span>
<span class="line" id="L418"><span style="color: #24292EFF">      </span></span>
<span class="line empty-line" id="L419"></span></code></pre>
          
                  
          <p>If resolvedIdParamsValues is null, then the flag <code>nullAndUnloadedPresent</code> is set to true and the cycle is interrupted
(since it’s impossible to load data without a valid ID).
Setting the flag This is crucial since the undesirable result of “nothing to load” <em>and</em> “some idParams are null”
will throw an error later down the track.</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 424;"><span class="line" id="L424"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (resolvedIdParamsValues[store] </span><span style="color: #D32F2F">===</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">null</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L425"><span style="color: #24292EFF">        nullAndUnloadedPresent </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">true</span></span>
<span class="line" id="L426"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">continue</span></span>
<span class="line" id="L427"><span style="color: #24292EFF">      }</span></span>
<span class="line empty-line" id="L428"></span>
<span class="line empty-line" id="L429"></span></code></pre>
          
                  
          <p>At this stage, there is an idParam value and no data already loaded (otherwise, given the two previous
ifs, the cycle would have <code>continue</code>d to the next iteration, searching for something to load).</p>
<p>It’s important to fully uderstand that:</p>
<ul>
<li>The <code>for</code> cycle’s job is to add promises to the <code>toLoad</code> array, where each promise will make one <code>fetch()</code> call</li>
<li>The number of promises depends on whether <code>aggressiveLoading</code> is set or not. If <code>aggressiveLoading</code> is <em>not</em> set,
then only one promises will be added (the <code>for</code> cycle will encounter a <code>break</code> after the first promise is added).</li>
<li>At the end of the cycle, if <code>toLoad</code> has values, <code>Promise.all()</code> will be called on <code>toLoad</code>, so that all
promises are resolved</li>
<li>The <code>for</code> cycle will be repeated as many times as needed. Since each <code>for</code> iteration might possible uncover
more IDs and records, which will enable loading in the next <code>while</code> iteration.</li>
</ul>
<p>The promises added to <code>toLoad</code> are functions that will work out the load URL adding <code>storeUrlPrefix</code>, and then
allow developers to change such url with the <code>fetchUrlModifier()</code> function. Crucially, once the data is loaded
it will be added to the <code>loadedElementData</code> object (so, the parameter will be skipped in future iterations of the
<code>for</code> cycle) <em>and</em> the function <code>lookIntoRecord()</code> will be called, which will potentially add extra entries
into <code>loadedElementData</code>, <code>resolvedIdParamsValues</code> and <code>resolvedListFilter</code> (depending of what’s in the record).</p>
<p>So, first of all, since there is an <code>idParam</code> and the data is not preloaded, push the async loading function’s
<em>result</em> (a promise) into the <code>toLoad</code> array (note: it won’t be resolved, just added)</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 451;"><span class="line" id="L451"><span style="color: #24292EFF">      </span><span style="color: #1976D2">toLoad</span><span style="color: #6F42C1">.push</span><span style="color: #24292EFF">(</span></span>
<span class="line" id="L452"><span style="color: #24292EFF">        (</span><span style="color: #D32F2F">async</span><span style="color: #24292EFF"> () </span><span style="color: #D32F2F">=&gt;</span><span style="color: #24292EFF"> { </span></span>
<span class="line" id="L453"><span style="color: #24292EFF">          </span></span>
<span class="line empty-line" id="L454"></span></code></pre>
          
                  
          <p>Manipulate the fetch URL as needed. Note that the prefix is part of the
nakedStoreUrl</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 456;"><span class="line" id="L456"><span style="color: #24292EFF">          </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> idParamValue </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> resolvedIdParamsValues[store]</span></span>
<span class="line" id="L457"><span style="color: #24292EFF">          </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> nakedStoreUrl </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">storeUrlPrefix</span><span style="color: #D32F2F">}</span><span style="color: #22863A">/</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">store</span><span style="color: #D32F2F">}</span><span style="color: #22863A">`</span></span>
<span class="line" id="L458"><span style="color: #24292EFF">          </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> url </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">nakedStoreUrl</span><span style="color: #D32F2F">}</span><span style="color: #22863A">/</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">idParamValue</span><span style="color: #D32F2F">}</span><span style="color: #22863A">`</span></span>
<span class="line empty-line" id="L459"></span></code></pre>
          
                  
          <p>console.log(‘loading URL:’, url)</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 460;"><span class="line" id="L460"><span style="color: #24292EFF">          </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">typeof</span><span style="color: #24292EFF"> fetchUrlModifier </span><span style="color: #D32F2F">===</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&#39;function&#39;</span><span style="color: #24292EFF">) url </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">fetchUrlModifier</span><span style="color: #24292EFF">(url</span><span style="color: #212121">,</span><span style="color: #24292EFF"> store</span><span style="color: #212121">,</span><span style="color: #24292EFF"> nakedStoreUrl</span><span style="color: #212121">,</span><span style="color: #24292EFF"> idParamValue</span><span style="color: #212121">,</span><span style="color: #24292EFF"> {}</span><span style="color: #212121">,</span><span style="color: #24292EFF"> dataUrlInfo)</span></span>
<span class="line empty-line" id="L461"></span>
<span class="line empty-line" id="L462"></span></code></pre>
          
                  
          <p>Actually fetch the record</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 463;"><span class="line" id="L463"><span style="color: #24292EFF">          </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #1976D2">config</span><span style="color: #24292EFF">.verbose) </span><span style="color: #1976D2">console</span><span style="color: #6F42C1">.log</span><span style="color: #24292EFF">(</span><span style="color: #22863A">&#39;FETCHING:&#39;</span><span style="color: #212121">,</span><span style="color: #24292EFF"> url)</span></span>
<span class="line" id="L464"><span style="color: #24292EFF">          </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> response </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">await</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">fetch</span><span style="color: #24292EFF">(url)</span></span>
<span class="line" id="L465"><span style="color: #24292EFF">          </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> record </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">await</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">response</span><span style="color: #6F42C1">.json</span><span style="color: #24292EFF">()</span></span>
<span class="line empty-line" id="L466"></span>
<span class="line" id="L467"><span style="color: #24292EFF">          loadedElementData[</span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">idParam</span><span style="color: #D32F2F">}</span><span style="color: #22863A">Record`</span><span style="color: #24292EFF">] </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> record</span></span>
<span class="line empty-line" id="L468"></span>
<span class="line" id="L469"><span style="color: #24292EFF">          </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">!</span><span style="color: #24292EFF">alreadylookedInto[</span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">idParam</span><span style="color: #D32F2F">}</span><span style="color: #22863A">Record`</span><span style="color: #24292EFF">]) {</span></span>
<span class="line" id="L470"><span style="color: #24292EFF">            </span><span style="color: #6F42C1">lookIntoRecord</span><span style="color: #24292EFF">(record</span><span style="color: #212121">,</span><span style="color: #24292EFF"> elementData</span><span style="color: #212121">,</span><span style="color: #24292EFF"> loadedElementData</span><span style="color: #212121">,</span><span style="color: #24292EFF"> resolvedIdParamsValues</span><span style="color: #212121">,</span><span style="color: #24292EFF">  resolvedListFilter</span><span style="color: #212121">,</span><span style="color: #24292EFF"> store2IdParams</span><span style="color: #212121">,</span><span style="color: #24292EFF"> isList</span><span style="color: #212121">,</span><span style="color: #24292EFF"> store)</span></span>
<span class="line" id="L471"><span style="color: #24292EFF">            alreadylookedInto[</span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">idParam</span><span style="color: #D32F2F">}</span><span style="color: #22863A">Record`</span><span style="color: #24292EFF">] </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">true</span></span>
<span class="line" id="L472"><span style="color: #24292EFF">          }</span></span>
<span class="line" id="L473"><span style="color: #24292EFF">          </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">true</span></span>
<span class="line" id="L474"><span style="color: #24292EFF">        })()</span></span>
<span class="line" id="L475"><span style="color: #24292EFF">      )</span></span>
<span class="line empty-line" id="L476"></span>
<span class="line empty-line" id="L477"></span></code></pre>
          
                  
          <p>Only allow pushing of more items here if aggressiveLoading is set.
If not, stop after adding one entry</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 479;"><span class="line" id="L479"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">!</span><span style="color: #24292EFF">aggressiveLoading) </span><span style="color: #D32F2F">break</span><span style="color: #24292EFF">     </span></span>
<span class="line" id="L480"><span style="color: #24292EFF">    }</span></span>
<span class="line empty-line" id="L481"></span>
<span class="line empty-line" id="L482"></span></code></pre>
          
                  
          <p>The <code>for</code> cycle has finished. The whole <code>for</code> cycle might well be repeated again; however, for now, this is
what can be loaded.</p>
<p>If there is nothing to load, then it will be game over one way or another.
If <code>nullAndUnloadedPresent</code> is true, then it’s the unwanted result: the data cannot be loaded, since IDs are
missing.
If <code>nullAndUnloadedPresent</code> is false, then it means loading is properly finished,</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 490;"><span class="line" id="L490"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">!</span><span style="color: #1976D2">toLoad</span><span style="color: #24292EFF">.</span><span style="color: #1976D2">length</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L491"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (nullAndUnloadedPresent) {</span></span>
<span class="line" id="L492"><span style="color: #24292EFF">        </span><span style="color: #1976D2">console</span><span style="color: #6F42C1">.error</span><span style="color: #24292EFF">(</span><span style="color: #22863A">&#39;Data on loading:&#39;</span><span style="color: #212121">,</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L493"><span style="color: #24292EFF">          dataUrlInfo</span><span style="color: #212121">,</span></span>
<span class="line" id="L494"><span style="color: #24292EFF">          loadedElementData</span><span style="color: #212121">,</span></span>
<span class="line" id="L495"><span style="color: #24292EFF">          resolvedIdParamsValues</span><span style="color: #212121">,</span></span>
<span class="line" id="L496"><span style="color: #24292EFF">          resolvedListFilter</span></span>
<span class="line" id="L497"><span style="color: #24292EFF">        })</span></span>
<span class="line" id="L498"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">throw</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Error</span><span style="color: #24292EFF">(</span><span style="color: #22863A">&#39;Not enough information to resolve the URL: &#39;</span><span style="color: #24292EFF">)</span></span>
<span class="line" id="L499"><span style="color: #24292EFF">      }</span></span>
<span class="line" id="L500"><span style="color: #24292EFF">      </span><span style="color: #C2C3C5">/* Break the `while` cycle: loading of records is finished */</span><span style="color: #24292EFF"> </span></span>
<span class="line" id="L501"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">break</span></span>
<span class="line empty-line" id="L502"></span>
<span class="line empty-line" id="L503"></span></code></pre>
          
                  
          <p>If there is something to load, then yes, load it. This is done by <code>await</code>ing the promises in <code>toLoad</code>.</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 504;"><span class="line" id="L504"><span style="color: #24292EFF">    } </span><span style="color: #D32F2F">else</span><span style="color: #24292EFF"> {</span></span>
<span class="line empty-line" id="L505"></span></code></pre>
          
                  
          <p>Load all pending store stuff</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 506;"><span class="line" id="L506"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> p</span></span>
<span class="line" id="L507"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #1976D2">toLoad</span><span style="color: #24292EFF">.</span><span style="color: #1976D2">length</span><span style="color: #24292EFF">) p </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">await</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Promise</span><span style="color: #6F42C1">.all</span><span style="color: #24292EFF">(toLoad)</span></span>
<span class="line" id="L508"><span style="color: #24292EFF">      totalLoads </span><span style="color: #D32F2F">+=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">toLoad</span><span style="color: #24292EFF">.</span><span style="color: #1976D2">length</span></span>
<span class="line" id="L509"><span style="color: #24292EFF">    }</span></span>
<span class="line empty-line" id="L510"></span>
<span class="line empty-line" id="L511"></span></code></pre>
          
                  
          <p>This point demarks the end of the while cycle. If the code reaches this point,
it means that something was loaded, but more network calls are possibly
necessary to fetch all of the needed data.</p>
<p>This can happen for example if an element with data path 
/users/:userId/addresses/:addressId is viewed in a page on route /addresses/:addressId – in which
case <code>:userId</code> is NOT resolved from the routing, but it IS resolved once the address
information is loaded (assuming that addresse have a property called <code>userId</code>)</p>
<p>The <code>for</code> cycle will restart, possibly adding promises to <code>toLoad</code>, and so on. </p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 521;"><span class="line" id="L521"><span style="color: #24292EFF">  }</span></span>
<span class="line empty-line" id="L522"></span>
<span class="line empty-line" id="L523"></span>
<span class="line empty-line" id="L524"></span></code></pre>
          
                  
          <p>There is a small, but ugly, possibility that even though all records were there, some Ids are
still missing. This must not happen, as the viewing element will be unable to reload
if needed. Do a check on that</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 527;"><span class="line" id="L527"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">idParamsMissing</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Object</span><span style="color: #6F42C1">.keys</span><span style="color: #24292EFF">(resolvedIdParamsValues)</span><span style="color: #6F42C1">.filter</span><span style="color: #24292EFF">(store </span><span style="color: #D32F2F">=&gt;</span><span style="color: #24292EFF"> resolvedIdParamsValues[store] </span><span style="color: #D32F2F">===</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">null</span><span style="color: #24292EFF">)</span></span>
<span class="line" id="L528"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #1976D2">idParamsMissing</span><span style="color: #24292EFF">.</span><span style="color: #1976D2">length</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L529"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">throw</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">Error</span><span style="color: #24292EFF">(</span><span style="color: #22863A">`Loading successful, but IDs missing for stores: </span><span style="color: #D32F2F">${</span><span style="color: #1976D2">idParamsMissing</span><span style="color: #6F42C1">.join</span><span style="color: #24292EFF">(</span><span style="color: #22863A">&#39;, &#39;</span><span style="color: #24292EFF">)</span><span style="color: #D32F2F">}</span><span style="color: #22863A">`</span><span style="color: #24292EFF">)</span></span>
<span class="line" id="L530"><span style="color: #24292EFF">  }</span></span>
<span class="line" id="L531"><span style="color: #24292EFF">  </span></span>
<span class="line empty-line" id="L532"></span>
<span class="line empty-line" id="L533"></span></code></pre>
          
                  
          <p>Now that the loading is done, there is potentially one more thing to do: addresses.
For example assume that the page URL is actually <code>/users/:userId/addresses/:addressId/deliveries</code></p>
<p>Such a URL will imply that <code>deliveries</code> is a store from which the code is after a <em>list</em> of
<code>deliveries</code> records. So, it will need to make one more <code>fetch</code> call <em>without</em> specifying the ID
after <code>deliveries</code>.</p>
<p>It will be potentially like this: <code>/users/10/addresses/20/deliveries</code></p>
<p>The same URL manipulation function is called, with <code>null</code> as <code>idParam</code> </p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 543;"><span class="line" id="L543"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (isList) {</span></span>
<span class="line" id="L544"><span style="color: #24292EFF">    </span></span>
<span class="line" id="L545"><span style="color: #24292EFF">    </span><span style="color: #C2C3C5">/* Manipulate the fetch URL as needed. Note that the prefix is part of the nakedStoreUrl */</span></span>
<span class="line" id="L546"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> searchParams </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">new</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">URLSearchParams</span><span style="color: #24292EFF">(resolvedListFilter)</span><span style="color: #6F42C1">.toString</span><span style="color: #24292EFF">()</span></span>
<span class="line" id="L547"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> nakedStoreUrl </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">storeUrlPrefix</span><span style="color: #D32F2F">}</span><span style="color: #22863A">/</span><span style="color: #D32F2F">${</span><span style="color: #1976D2">dataUrlInfo</span><span style="color: #24292EFF">.listStore</span><span style="color: #D32F2F">}</span><span style="color: #22863A">`</span></span>
<span class="line" id="L548"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> searchParamsAsString </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> searchParams </span><span style="color: #D32F2F">?</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&#39;?&#39;</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">+</span><span style="color: #24292EFF"> searchParams </span><span style="color: #D32F2F">:</span><span style="color: #24292EFF"> searchParams </span></span>
<span class="line" id="L549"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> url </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">nakedStoreUrl</span><span style="color: #D32F2F">}${</span><span style="color: #24292EFF">searchParamsAsString</span><span style="color: #D32F2F">}</span><span style="color: #22863A">`</span></span>
<span class="line" id="L550"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">typeof</span><span style="color: #24292EFF"> fetchUrlModifier </span><span style="color: #D32F2F">===</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&#39;function&#39;</span><span style="color: #24292EFF">) url </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">fetchUrlModifier</span><span style="color: #24292EFF">(url</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">dataUrlInfo</span><span style="color: #24292EFF">.listStore</span><span style="color: #212121">,</span><span style="color: #24292EFF"> nakedStoreUrl</span><span style="color: #212121">,</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">null</span><span style="color: #212121">,</span><span style="color: #24292EFF"> searchParams</span><span style="color: #212121">,</span><span style="color: #24292EFF"> dataUrlInfo)</span></span>
<span class="line empty-line" id="L551"></span>
<span class="line" id="L552"><span style="color: #24292EFF">    </span><span style="color: #C2C3C5">/* Actually fetch the list */</span></span>
<span class="line" id="L553"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #1976D2">config</span><span style="color: #24292EFF">.verbose) </span><span style="color: #1976D2">console</span><span style="color: #6F42C1">.log</span><span style="color: #24292EFF">(</span><span style="color: #22863A">&#39;FETCHING:&#39;</span><span style="color: #212121">,</span><span style="color: #24292EFF"> url)</span></span>
<span class="line" id="L554"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">response</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">await</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">fetch</span><span style="color: #24292EFF">(url)</span></span>
<span class="line" id="L555"><span style="color: #24292EFF">    loadedElementData[</span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #1976D2">dataUrlInfo</span><span style="color: #24292EFF">.listStore</span><span style="color: #D32F2F">}</span><span style="color: #22863A">List`</span><span style="color: #24292EFF">] </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">await</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">response</span><span style="color: #6F42C1">.json</span><span style="color: #24292EFF">() </span></span>
<span class="line" id="L556"><span style="color: #24292EFF">  }</span></span>
<span class="line empty-line" id="L557"></span>
<span class="line empty-line" id="L558"></span></code></pre>
          
                  
          <p>The end result of ths function, as explained at the very beginning, is making network requests
and return the objects <code>loadedElementData</code>, <code>resolvedIdParamsValues</code> and <code>resolvedListFilter</code> (for lists).</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 561;"><span class="line" id="L561"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> {</span></span>
<span class="line" id="L562"><span style="color: #24292EFF">    loadedElementData</span><span style="color: #212121">,</span></span>
<span class="line" id="L563"><span style="color: #24292EFF">    resolvedIdParamsValues</span><span style="color: #212121">,</span></span>
<span class="line" id="L564"><span style="color: #24292EFF">    resolvedListFilter</span><span style="color: #D32F2F">:</span><span style="color: #24292EFF"> resolvedListFilter </span><span style="color: #D32F2F">||</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">null</span><span style="color: #212121">,</span></span>
<span class="line" id="L565"><span style="color: #24292EFF">    totalLoads</span></span>
<span class="line" id="L566"><span style="color: #24292EFF">  }</span></span>
<span class="line" id="L567"><span style="color: #24292EFF">}</span></span>
<span class="line empty-line" id="L568"></span>
<span class="line empty-line" id="L569"></span></code></pre>
          
                  
          <p>Its job is to change loadedElementData, resolvedIdParamsValues, resolvedListFilter depending of the contents of
<code>record</code>, <code>elementData</code> and <code>loadedElementData</code>. <code>store2IdParams</code>, <code>isList</code> and <code>store</code> are accessory information
to make that possible.</p>
<p>In detail:</p>
<ul>
<li><code>loadedElementData</code>. It looks for properties in the record with names matching the store name and <code>Record</code> (such
 as <code>userIdRecord</code>). </li>
<li><code>resolvedIdParamsValues</code> and <code>resolvedListFilter</code>. It looks for properties in the record with names matching
 idParams (such as <code>userId</code> in the address record), and uses it to fill in the blanks
Rather than using recursion, the function analyses the passed <code>record</code>: if it finds propperties that represent
other records, it will add those to the list of records to check and will continue the cycle.</li>
</ul>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 581;"><span class="line" id="L581"><span style="color: #D32F2F">function</span><span style="color: #24292EFF"> </span><span style="color: #6F42C1">lookIntoRecord</span><span style="color: #24292EFF">(record</span><span style="color: #212121">,</span><span style="color: #24292EFF"> elementData</span><span style="color: #212121">,</span><span style="color: #24292EFF"> loadedElementData</span><span style="color: #212121">,</span><span style="color: #24292EFF"> resolvedIdParamsValues</span><span style="color: #212121">,</span><span style="color: #24292EFF"> resolvedListFilter</span><span style="color: #212121">,</span><span style="color: #24292EFF"> store2IdParams</span><span style="color: #212121">,</span><span style="color: #24292EFF"> isList</span><span style="color: #212121">,</span><span style="color: #24292EFF"> store) {</span></span>
<span class="line empty-line" id="L582"></span>
<span class="line" id="L583"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">typeof</span><span style="color: #24292EFF"> record  </span><span style="color: #D32F2F">!==</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&#39;object&#39;</span><span style="color: #24292EFF"> ) </span><span style="color: #D32F2F">return</span><span style="color: #24292EFF"> </span></span>
<span class="line empty-line" id="L584"></span>
<span class="line empty-line" id="L585"></span></code></pre>
          
                  
          <p>The function works by unshifting elements from the <code>recordToCheck</code> array, which is primed to only contain
the passed <code>record</code>.</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 587;"><span class="line" id="L587"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">recordsToCheck</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> []</span></span>
<span class="line" id="L588"><span style="color: #24292EFF">  </span><span style="color: #1976D2">recordsToCheck</span><span style="color: #6F42C1">.push</span><span style="color: #24292EFF">(record)</span></span>
<span class="line empty-line" id="L589"></span>
<span class="line empty-line" id="L590"></span></code></pre>
          
                  
          <p>The cycle starts now: in the first iteration, the only element there is shifted out and <code>recordsToCheck</code> becomes
empty.</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 592;"><span class="line" id="L592"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> r</span></span>
<span class="line" id="L593"><span style="color: #24292EFF">  </span><span style="color: #D32F2F">while</span><span style="color: #24292EFF"> (r </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">recordsToCheck</span><span style="color: #6F42C1">.shift</span><span style="color: #24292EFF">()) {</span></span>
<span class="line empty-line" id="L594"></span>
<span class="line empty-line" id="L595"></span></code></pre>
          
                  
          <p>Go through all stores again (that is, all keys of the <code>resolvedIdParamsValues</code> object) and look for information
in the loaded record:</p>
<ul>
<li>idParamsValues that were missing from the URL, or</li>
<li><code>[...idParam...]Record</code> entries in the loadedElement structure)</li>
</ul>
<p>Assume that the data URL is like this: <code>/users/:userId/usersExtra/:userId/addresses/:addressId</code>, and the page URL is
like this <code>/addresses/:addressId</code>, and fetching the address record returns a record that includes <code>userId</code>;<br>the cycle will go through each store/idParam values (<code>users/userId</code>, <code>usersExtra/userId</code> and <code>addresses/addressId</code>). 
Since <code>resolvedIdParamsValues.users</code> and <code>resolvedIdParamsValues.usersExtra</code> are initally null (since the page URL
doesn’t include them), and since the record includes the matching idParam (<code>userId</code>), the idParam <code>userId</code> will be added
to resolvedIdParamsValues for both <code>users</code> and <code>usersExtra</code>.</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 608;"><span class="line" id="L608"><span style="color: #24292EFF">    </span><span style="color: #D32F2F">for</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">let</span><span style="color: #24292EFF"> store </span><span style="color: #D32F2F">in</span><span style="color: #24292EFF"> resolvedIdParamsValues) { </span></span>
<span class="line" id="L609"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">idParam</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> store2IdParams[store]</span></span>
<span class="line empty-line" id="L610"></span>
<span class="line empty-line" id="L611"></span></code></pre>
          
                  
          <p>Look for missing store IDs in the loaded record
If the loaded record has a paramIdValue that was missing (not present in routingData)
it will most certainly be a valid idParams (which was missing in the URL in the first place)</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 615;"><span class="line" id="L615"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">typeof</span><span style="color: #24292EFF"> r[idParam] </span><span style="color: #D32F2F">!==</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&#39;undefined&#39;</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">&amp;&amp;</span><span style="color: #24292EFF"> resolvedIdParamsValues[store] </span><span style="color: #D32F2F">===</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">null</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L616"><span style="color: #24292EFF">        resolvedIdParamsValues[store] </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> r[idParam]</span></span>
<span class="line" id="L617"><span style="color: #24292EFF">      }</span></span>
<span class="line empty-line" id="L618"></span>
<span class="line empty-line" id="L619"></span></code></pre>
          
                  
          <p>Look for a <code>[...idParam...]Record</code> entry in the loaded record. For example the record for the addresses
store might contain the <code>userIdRecord</code> property, and – since the URL includes 
<code>/users/:userId/addresses/:addressId</code> – it will be assumed to contain a valid record for the <code>users</code> store
If that is the case, the property’s content (supposed to be a full record object) will be assigned to
<code>loadedElementData</code> object for that store straight away.</p>
<p>The property’s content will <em>also</em> ne added to the list of records to be checked, which will make this very
while() cycle go for longer, since the statement <code>r = recordsToCheck.shift()</code> will return another record.</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 628;"><span class="line" id="L628"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">const</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">elementDataRecord</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> elementData[</span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">idParam</span><span style="color: #D32F2F">}</span><span style="color: #22863A">Record`</span><span style="color: #24292EFF">] </span><span style="color: #D32F2F">||</span><span style="color: #24292EFF"> loadedElementData[</span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">idParam</span><span style="color: #D32F2F">}</span><span style="color: #22863A">Record`</span><span style="color: #24292EFF">]</span></span>
<span class="line empty-line" id="L629"></span>
<span class="line" id="L630"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (</span><span style="color: #D32F2F">!</span><span style="color: #24292EFF">elementDataRecord </span><span style="color: #D32F2F">&amp;&amp;</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">typeof</span><span style="color: #24292EFF"> r[</span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">idParam</span><span style="color: #D32F2F">}</span><span style="color: #22863A">Record`</span><span style="color: #24292EFF">]  </span><span style="color: #D32F2F">!==</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&#39;undefined&#39;</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L631"><span style="color: #24292EFF">        loadedElementData[</span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">idParam</span><span style="color: #D32F2F">}</span><span style="color: #22863A">Record`</span><span style="color: #24292EFF">] </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> r[</span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">idParam</span><span style="color: #D32F2F">}</span><span style="color: #22863A">Record`</span><span style="color: #24292EFF">]                  </span></span>
<span class="line" id="L632"><span style="color: #24292EFF">        </span><span style="color: #1976D2">recordsToCheck</span><span style="color: #6F42C1">.push</span><span style="color: #24292EFF">(r[</span><span style="color: #22863A">`</span><span style="color: #D32F2F">${</span><span style="color: #24292EFF">idParam</span><span style="color: #D32F2F">}</span><span style="color: #22863A">Record`</span><span style="color: #24292EFF">])</span></span>
<span class="line" id="L633"><span style="color: #24292EFF">      }</span></span>
<span class="line empty-line" id="L634"></span>
<span class="line empty-line" id="L635"></span></code></pre>
          
                  
          <p>For lists, also try and resolve the list filter in case some
parameters are missing and are present in the loaded record</p>

          
            <pre class="shiki" style="background-color: transparent"><code style="--line-start-number: 637;"><span class="line" id="L637"><span style="color: #24292EFF">      </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (isList) {</span></span>
<span class="line" id="L638"><span style="color: #24292EFF">        </span><span style="color: #D32F2F">if</span><span style="color: #24292EFF"> (resolvedListFilter[idParam] </span><span style="color: #D32F2F">===</span><span style="color: #24292EFF"> </span><span style="color: #1976D2">null</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">&amp;&amp;</span><span style="color: #24292EFF"> </span><span style="color: #D32F2F">typeof</span><span style="color: #24292EFF"> r[idParam] </span><span style="color: #D32F2F">!==</span><span style="color: #24292EFF"> </span><span style="color: #22863A">&#39;undefined&#39;</span><span style="color: #24292EFF">) {</span></span>
<span class="line" id="L639"><span style="color: #24292EFF">          resolvedListFilter[idParam] </span><span style="color: #D32F2F">=</span><span style="color: #24292EFF"> r[idParam]</span></span>
<span class="line" id="L640"><span style="color: #24292EFF">        }</span></span>
<span class="line" id="L641"><span style="color: #24292EFF">      }</span></span>
<span class="line" id="L642"><span style="color: #24292EFF">    }</span></span>
<span class="line" id="L643"><span style="color: #24292EFF">  }</span></span>
<span class="line" id="L644"><span style="color: #24292EFF">}</span></span>
<span class="line empty-line" id="L645"></span>
<span class="line empty-line" id="L646"></span>
<span class="line empty-line" id="L647"></span></code></pre>
          
        
      
      </article>
      

        
    </section>
  </main>
  <footer></footer>
  
    <ee-drawer id="drawer" class="side-menu">
     <ul>
        
          
          
            <li>
                <a class="source " href="index.html">
                    home
                </a>
            </li>
          
        
          
          
            <li>
                <a class="source " href="documentation.html">
                    documentation
                </a>
            </li>
          
        
          
          
            <li>
                <a class="source  current " href="literate-code.html">
                    literate code
                </a>
            </li>
          
        
      </ul>
    </ee-drawer>
  
</body>
<script>
  const drawer = document.getElementById('drawer')
  this.addEventListener('menu-clicked', () => {
    drawer.toggle()
  })

  const header = document.getElementById('header')
  header.menu = (Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0) < 800)
  this.addEventListener('click', () => {
    const toc = document.querySelector('.toc')
    if (toc) {
      sessionStorage.setItem(`${location.pathname.split('/')[1]}_toc`, String(toc.scrollTop))
    }
  })
  this.addEventListener('load', () => {
    const toc = document.querySelector('.toc')
    if (toc) {
      const tocScrollPosition = sessionStorage.getItem(`${location.pathname.split('/')[1]}_toc`)
      if (tocScrollPosition) toc.scrollTop = Number(tocScrollPosition)
    }
  })
</script>




</html>
